//
// Generated by dtk
// Translation Unit: d_a_obj_tntrap.cpp
//

#include "d/actor/d_a_obj_tntrap.h"
#include "d/actor/d_a_player.h"
#include "d/actor/d_a_ship.h"
#include "d/d_com_inf_game.h"
#include "d/d_procname.h"
#include "d/d_priority.h"
#include "m_Do/m_Do_mtx.h"
#include "d/res/res_tntrap.h"
#include "weak_data_2100_2080.h"
#include "weak_data_1811.h"


#if VERSION == VERSION_DEMO
daObjTnTrap_HIO_c l_HIO;
#endif


namespace{
    const char l_arcname[] = "TnTrap";

    static const dCcD_SrcTri l_tri_src = {
        {
            /* Flags             */ 0,
            /* SrcObjAt  Type    */ AT_TYPE_UNK800,
            /* SrcObjAt  Atp     */ 1,
            /* SrcObjAt  SPrm    */ cCcD_AtSPrm_Set_e | cCcD_AtSPrm_VsPlayer_e,
            /* SrcObjTg  Type    */ AT_TYPE_UNK0,
            /* SrcObjTg  SPrm    */ cCcD_TgSPrm_UNK0,
            /* SrcObjCo  SPrm    */ cCcD_CoSPrm_UNK0,
            /* SrcGObjAt Se      */ 0,
            /* SrcGObjAt HitMark */ 0x00,
            /* SrcGObjAt Spl     */ dCcG_At_Spl_UNKB,
            /* SrcGObjAt Mtrl    */ 0,
            /* SrcGObjAt SPrm    */ 0,
            /* SrcGObjTg Se      */ 0,
            /* SrcGObjTg HitMark */ 0,
            /* SrcGObjTg Spl     */ 0,
            /* SrcGObjTg Mtrl    */ 0,
            /* SrcGObjTg SPrm    */ 0,
            /* SrcGObjCo SPrm    */ 0,
        },
        {
            /* a */ 0.0f, 0.0f, 0.0f,
            /* b */ 0.0f, 0.0f, 0.0f,
            /* c */ 0.0f, 0.0f, 0.0f,
        },
    };

    static const Vec l_tri_vtx[6] = {
    300.0, -70.0, 0.0, 
    -300.0, -70.0, 0.0, 
    -300.0, 55.0, 0.0, 
    300.0, 55.0, 0.0, 
    300.0, 180.0, 0.0, 
    -300.0, 180.0, 0.0,

    };



    static const f32 l_offset_ball[2][3] = {
        -300,90,0,
        300,90,0
    };
    static const f32 l_offset_thunder[3][3] = {
        0,25,0,
        0,85,0,
        0,145,0

    };       

        
};

#if VERSION == VERSION_DEMO
daObjTnTrap_HIO_c::daObjTnTrap_HIO_c(){
    mNo = -1;
    field8 = 500.0f;
    fieldC = 0.0f;
    field10 = 0.0f;
    field14 = -94.0f;
    field18 = 80.0f;
    field1C = 150.0f;
    field20 = 0;
    field21 = 0;
    field22 = 1;
    field23 = 1;
}
#endif

/* 00000078-000002AC       .text chk_appear__13daObjTnTrap_cFv */
BOOL daObjTnTrap_c::chk_appear() {

    BOOL o_retval = FALSE;
    mSwSave = param_get_swSave();
    mSwSave2 = param_get_swSave2();
    mArg0 = param_get_arg0();
    mMapType = param_get_mapType();
    switch(mMapType){
    case 0:
        if(dComIfGs_isEventBit(dSv_evtBit_c::EVT_UNK3A04) == TRUE){
            if(mSwSave != 0xFF && fopAcM_isSwitch(this,mSwSave) == 1){
                if(dComIfGs_getTriforceNum() == 8 && mArg0 == 0){
                    if(dComIfGs_isEventBit(dSv_evtBit_c::EVT_UNK2C01) == 1){
                        if(mSwSave2 != 0xFF && !fopAcM_isSwitch(this,mSwSave2)){
                            field_0x298 = 2;
                            o_retval = TRUE;
                        }
                    }else{
                        field_0x298 = 1;
                        o_retval = TRUE;
                    }
                }
            }else{
                field_0x298 = 0;
                o_retval = TRUE;
            }
        }
        break;
    case 1:
        if(mSwSave != 0xFF && !fopAcM_isSwitch(this,mSwSave)){
            field_0x298 = 3;
            o_retval = TRUE;
        }
        break;
    case 2:
        if(mSwSave != 0xFF){
            if(!fopAcM_isSwitch(this,mSwSave)){
                field_0x298 = 5;
                o_retval = TRUE;
            }
        }else{
            field_0x298 = 5;
            o_retval = TRUE;       
        }
        break;
    default:   
        JUT_ASSERT(380,0);
        break;
    }
    return o_retval;
}


/* 000002AC-00000344       .text set_mtx__13daObjTnTrap_cFv */
void daObjTnTrap_c::set_mtx() {
    mDoMtx_stack_c::transS(home.pos);
    mDoMtx_stack_c::XYZrotM(shape_angle);
#if VERSION == VERISON_DEMO
    mDoMtx_stack_c::transM(0.0,-9000.0,l_HIO.field8);
#else
    mDoMtx_stack_c::transM(0.0,-9000.0,-94.0);
#endif
    mDoMtx_stack_c::scaleM(scale.x,100.0,scale.z);
    cMtx_copy(mDoMtx_stack_c::get(),field_0xD5C.calcMtx);
}

/* 00000344-00000368       .text solidHeapCB__13daObjTnTrap_cFP10fopAc_ac_c */
 int daObjTnTrap_c::solidHeapCB(fopAc_ac_c* actor) {
    return ((daObjTnTrap_c*)actor)->create_heap();
}

/* 00000368-000003E4       .text create_heap__13daObjTnTrap_cFv */
bool daObjTnTrap_c::create_heap() {
    bool o_retval = true;
    cBgD_t* pcVar1 = (cBgD_t*)dComIfG_getObjectRes(l_arcname,TNTRAP_DZB_TN_WALL01);
    field_0xD58 = dBgW_NewSet(pcVar1,cBgW::MOVE_BG_e,&field_0xD5C.calcMtx);
    if(field_0xD58 == NULL){
        o_retval = false;
    }
    return o_retval;

    
}


/* 000003E4-000005F8       .text particle_set__13daObjTnTrap_cFif */
void daObjTnTrap_c::particle_set(int i_particleId, float param_2) {

   cXyz ball;

    if(field_0xDE0[i_particleId] == 1){
        if(field_0xDE4[i_particleId] != param_2){
            particle_delete(i_particleId);
        }else{
            return;
        }
    }

    for(int i = 0; i < 2; i++){
        if(field_0xD5C.emitterPairs[i_particleId][i] == NULL){
            ball.x = l_offset_ball[i][0];
            ball.y = l_offset_ball[i][1]+param_2;
            ball.z = l_offset_ball[i][2];
            field_0xD5C.emitterPairs[i_particleId][i] = dComIfGp_particle_set(0x82EA,&home.pos,&shape_angle);
            field_0xD5C.emitterPairs[i_particleId][i]->setEmitterTranslation(JGeometry::TVec3<f32>(ball.x,ball.y,ball.z));
        }
    }
    for(int i = 0; i < 3; i++){
        if(field_0xD5C.emitterPairs2[i_particleId][i] == NULL){
            ball.x = l_offset_thunder[i][0];
            ball.y = l_offset_thunder[i][1]+param_2;
            ball.z = l_offset_thunder[i][2];
            field_0xD5C.emitterPairs2[i_particleId][i] = dComIfGp_particle_set(0x82EB,&home.pos,&shape_angle);
            field_0xD5C.emitterPairs2[i_particleId][i]->setEmitterTranslation(JGeometry::TVec3<f32>(ball.x,ball.y,ball.z));
        }
    }
    field_0xDE4[i_particleId] = param_2;
    field_0xDE0[i_particleId] = 1;
    return;
}

/* 000005F8-000006A4       .text particle_delete__13daObjTnTrap_cFi */
void daObjTnTrap_c::particle_delete(int param_1) {

    if(field_0xDE0[param_1] == 1){
        int i;
        for(i = 0; i < 2; i++){
            if(field_0xD5C.emitterPairs[param_1][i] != 0){
                field_0xD5C.emitterPairs[param_1][i]->becomeInvalidEmitter();
                field_0xD5C.emitterPairs[param_1][i] = NULL;
            }
        }
        for(i = 0; i < 3; i++){
            if(field_0xD5C.emitterPairs2[param_1][i] != 0){
                field_0xD5C.emitterPairs2[param_1][i]->becomeInvalidEmitter();
                field_0xD5C.emitterPairs2[param_1][i] = NULL;
            }
        }
    }
    field_0xDE0[param_1] = 0;
    return;
    
}

/* 000006A4-0000072C       .text set_se__13daObjTnTrap_cFv */
void daObjTnTrap_c::set_se() {

    if(field_0xDC0 >= 5 || field_0xDC0 < 1){
        return;
    }
    fopAcM_seStartCurrent(this,JA_SE_OBJ_TN_TRAP,0);

}


/* 0000072C-000008A0       .text set_tri__13daObjTnTrap_cFi */
void daObjTnTrap_c::set_tri(int param_1) {

    cXyz local_58[3];
    static s32 table_idx [4][3] = {
        0,1,2,
        0,2,3,
        3,2,5,
        3,5,4
    };
    mDoMtx_stack_c::transS(home.pos.x,home.pos.y+field_0xDE4[param_1],home.pos.z);
    mDoMtx_stack_c::XYZrotM(shape_angle);
    for(int i = 0; i < 4; i++){

        for(int j = 0; j < 3; j++){
            local_58[j] = l_tri_vtx[table_idx[i][j]];
            mDoMtx_stack_c::multVec(&local_58[j],&local_58[j]);
        }
        mTri[param_1][i].setPos(&local_58[0],&local_58[1],&local_58[2]);
    }


}   

/* 000008A0-00000A10       .text chk_event_flg__13daObjTnTrap_cFv */
bool daObjTnTrap_c::chk_event_flg() {

    bool o_retval = 1;
    switch(field_0x298){
        case 1:
            break;
        case 0:
            if(mSwSave != 0xFF && fopAcM_isSwitch(this,mSwSave) == 1){
                int var_29 = 4;
                if(mArg0 == 0){
                    var_29 = 2;
                    dComIfGs_onEventBit(dSv_evtBit_c::EVT_UNK3B40);

                }
                setup_action(var_29);
            }
            break;
            
        case 2:
            if(field_0xDC0 == 1){
                setup_action(2);
            }
            break;
        case 3:
            if(mSwSave != 0xFF && fopAcM_isSwitch(this,mSwSave) == 1){
                daShip_c* ship = (daShip_c*)dComIfGp_getShipActor();
                if(ship){
                    ship->offFantomGanonBattle();
                    fopAcM_delete(this);
                    o_retval = false;
                }
            }
            break;
        case 5:
            if(mSwSave != 0xFF && fopAcM_isSwitch(this,mSwSave) == 1){
                fopAcM_delete(this);
                o_retval = false;
            }
            break;
    }
    return o_retval;
}

/* 00000A10-00000A98       .text set_em_set_offsetY__13daObjTnTrap_cFv */
void daObjTnTrap_c::set_em_set_offsetY() {

    if(field_0x298 == 5){
        daPy_py_c* player = daPy_getPlayerActorClass();
        if(daPy_getPlayerActorClass() != NULL){
            float diff = player->eyePos.y - home.pos.y;
            field_0xDE4[0] = (int)(diff / 180.0f) * 180.0f;
        }
    }else{
        field_0xDE4[0] = 0.0;
    }
    return; 
}

/* 00000A98-00000C78       .text _create__13daObjTnTrap_cFv */
cPhs_State daObjTnTrap_c::_create() {

    cPhs_State o_phs_state = cPhs_ERROR_e;
    fopAcM_SetupActor(this,daObjTnTrap_c);
    if(fopAcM_IsFirstCreating(this)){
        field_0xDC4 = chk_appear();
    }
    if(field_0xDC4 == TRUE){
        o_phs_state = dComIfG_resLoad(&mPhaseProcess,l_arcname); 
    }
    if(o_phs_state == cPhs_COMPLEATE_e){
        if(fopAcM_entrySolidHeap(this,this->solidHeapCB,0x2E0)){
            if(field_0x298 != 3 && dComIfG_Bgsp()->Regist(field_0xD58,this) != 0){
                o_phs_state = cPhs_ERROR_e;
            }else{
                set_em_set_offsetY();
                set_mtx();
                mStts.Init(0xFF,0xFF,this);

                for(int i = 0; i < 2; i++){
                    for(int j = 0; j < 4; j++){
                        mTri[i][j].Set(l_tri_src);
                        mTri[i][j].SetStts(&mStts);
                    }
                    set_tri(i);
                }
                int action_param = 0;
                if(field_0x298 == 3){
                    action_param=6;
                }
                setup_action(action_param);
            }
        }else{
            o_phs_state = cPhs_ERROR_e;
        }  
    }
    return o_phs_state;

}

/* 00000F8C-00001050       .text _delete__13daObjTnTrap_cFv */
bool daObjTnTrap_c::_delete() {

    bool release;

    if (field_0xDC4 == 1) {
    dComIfG_resDelete(&mPhaseProcess,l_arcname);
        if (heap != NULL){
            if(field_0xD58 != NULL) {
                if ((field_0xD58->GetId() >= 0) && (field_0xD58->GetId() < 0x100)) {
                    release = true;
                }
                else {
                    release = false;
                }
                if (release) {
                    dComIfG_Bgsp()->Release(field_0xD58);
                }
                field_0xD58 = NULL;
            }
        }

        for(int i = 0; i < 2; i++){
            particle_delete(i);
        }

    }
    return true;
}

/* 00001050-00001150       .text trap_off_wait_act_proc__13daObjTnTrap_cFv */
bool daObjTnTrap_c::trap_off_wait_act_proc() {

    if(daPy_getPlayerActorClass() != NULL){
        f32 pos_diff = (daPy_getPlayerActorClass()->current.pos-home.pos).absXZ();
        if(pos_diff < 500.0f){
            setup_action(1);
        }
    }
    
    return chk_event_flg();
}

/* 00001150-00001384       .text trap_on_wait_act_proc__13daObjTnTrap_cFv */
bool daObjTnTrap_c::trap_on_wait_act_proc() {
    daPy_py_c* player = (daPy_py_c*)daPy_getPlayerActorClass();
    int i;
    float local_64[2];
    if(player != NULL){
        if((player->current.pos-home.pos).absXZ() > 500.0f){
            setup_action(0);
        }else if(field_0x298 == 5){
            for(i = 0; i < 2; i++){
                local_64[i] = player->current.pos.y - (home.pos.y + field_0xDE4[i] +90.0f);
                if(std::abs(local_64[i]) > 150.0f){
                    particle_delete(i);
                }
            }
            for(i = 0; i < 2; i++){
                f32 fVar6;
                if(std::abs(local_64[i]) > 80.0f){
                    if(local_64[i] > 0.0f){
                        fVar6 = field_0xDE4[i]+180.0f;
                    }else{
                        fVar6 = field_0xDE4[i]-180.0f;
                    }
                    if(std::abs(player->current.pos.y - (home.pos.y + fVar6 + 90.0f)) <= 150.0f){
                        particle_set(i^1,fVar6);
                    }
                }

            }
        }
    } 
    return chk_event_flg();
}

/* 00001384-00001448       .text demo_regist_wait_act_proc__13daObjTnTrap_cFv */
bool daObjTnTrap_c::demo_regist_wait_act_proc() {
    if(field_0xDD8[0] != -1){
        if(eventInfo.checkCommandDemoAccrpt()){
            setup_action(3);
        }else{
            fopAcM_orderOtherEventId(this,field_0xDD8[0],0xFF,0xFFFF,0,1);
        }
    }else{
        if(field_0x298 == 2){
            field_0xDD8[0] = dComIfGp_evmng_getEventIdx("break_tntrap2",0xFF);
        }else{
            field_0xDD8[0] = dComIfGp_evmng_getEventIdx("break_tntrap",0xFF);            
        }
    }
    return 1;
}

/* 00001448-000014F0       .text demo_wait_act_proc__13daObjTnTrap_cFv */
bool daObjTnTrap_c::demo_wait_act_proc() {
    if(dComIfGp_evmng_existence(field_0xDD8[0])){
        int iVar2 = dComIfGp_evmng_getMyStaffId("TnTrap");
        if(iVar2 != -1){
            char* cVar1 = dComIfGp_getPEvtManager()->getMyNowCutName(iVar2);
            if(!strcmp(cVar1,"Delete")){
                setup_action(5);
            }
        }
    }
    return 1;
}

/* 000014F0-000015B4       .text demo_wait2_act_proc__13daObjTnTrap_cFv */
bool daObjTnTrap_c::demo_wait2_act_proc() {
    bool retval = true;
    s16 event_idx = dComIfGp_evmng_getEventIdx("break_tntrap");
    if(dComIfGp_evmng_existence(event_idx)){
        int iVar2 = dComIfGp_evmng_getMyStaffId("TnTrap");
        if(iVar2 != -1){
            char* cVar1 = dComIfGp_getPEvtManager()->getMyNowCutName(iVar2);
            if(!strcmp(cVar1,"Delete2")){
                fopAcM_delete(this);
                retval = 0;
            }
        }
    }
    return retval;
}

/* 000015B4-000016A8       .text demo_end_wait_act_proc__13daObjTnTrap_cFv */
bool daObjTnTrap_c::demo_end_wait_act_proc() {

    bool o_retval = true;
    if(dComIfGp_evmng_endCheck(field_0xDD8[0])){
        dComIfGp_event_reset();
        switch(field_0x298){
            case 1:
                break;
            case 0:
                mDoAud_seStart(JA_SE_READ_RIDDLE_1);
                break;
            case 2:
                if(mSwSave2 == 0xFF){
                    break;
                }
                fopAcM_onSwitch(this,mSwSave2);
                break;
        }
        fopAcM_delete(this);
        o_retval = false;
    }
    return o_retval;

}

/* 000016A8-00001740       .text hide_wait_act_proc__13daObjTnTrap_cFv */
bool daObjTnTrap_c::hide_wait_act_proc() {
    if(mSwSave2 != 0xFF && fopAcM_isSwitch(this,mSwSave2) == 1){
        daShip_c* ship = (daShip_c*)dComIfGp_getShipActor();
        if(ship){
            ship->onFantomGanonBattle();
            if(dComIfG_Bgsp()->Regist(field_0xD58,this) == 0){
                setup_action(0);
            }
        }

    }
    return 0;
}

/* 00001740-00001744       .text dummy_proc__13daObjTnTrap_cFv */
void daObjTnTrap_c::dummy_proc() {
    return;
}

/* 00001744-00001790       .text trap_off_wait_act_init_proc__13daObjTnTrap_cFv */
void daObjTnTrap_c::trap_off_wait_act_init_proc() {

    for(int i = 0; i < 2; i++){
        particle_delete(i);
    }
    return;
}

/* 00001790-000017CC       .text trap_on_wait_act_init_proc__13daObjTnTrap_cFv */
void daObjTnTrap_c::trap_on_wait_act_init_proc() {
    set_em_set_offsetY();
    particle_set(0,field_0xDE4[0]);
}

/* 000017CC-00001860       .text demo_regist_wait_act_init_proc__13daObjTnTrap_cFv */
void daObjTnTrap_c::demo_regist_wait_act_init_proc() {
    field_0xDE4[0] = 0.0f;
    particle_set(0,0.0f);
    if(field_0x298 == 2){
        field_0xDD8[0] = dComIfGp_evmng_getEventIdx("break_tntrap2");
    }else{
        field_0xDD8[0] = dComIfGp_evmng_getEventIdx("break_tntrap");
    }
    return;
}

/* 00001860-00001890       .text demo_wait2_act_init_proc__13daObjTnTrap_cFv */
void daObjTnTrap_c::demo_wait2_act_init_proc() {
    field_0xDE4[0] = 0.0f;
    particle_set(0,0.0f);
    return;
}

/* 00001890-000018DC       .text demo_end_wait_act_init_proc__13daObjTnTrap_cFv */
void daObjTnTrap_c::demo_end_wait_act_init_proc() {
    for(int i = 0; i < 2; i++){
        particle_delete(i);
    }
    return;
}

/* 000018DC-00001AE4       .text setup_action__13daObjTnTrap_cFi */
void daObjTnTrap_c::setup_action(int param_1) {

    static ActProcFunc act_proc[7] = {
        &daObjTnTrap_c::trap_off_wait_act_proc,
        &daObjTnTrap_c::trap_on_wait_act_proc,
        &daObjTnTrap_c::demo_regist_wait_act_proc,
        &daObjTnTrap_c::demo_wait_act_proc,
        &daObjTnTrap_c::demo_wait2_act_proc,
        &daObjTnTrap_c::demo_end_wait_act_proc,
        &daObjTnTrap_c::hide_wait_act_proc,
    };

    static InitProcFunc act_init_proc[7] = {
        &daObjTnTrap_c::trap_off_wait_act_init_proc,
        &daObjTnTrap_c::trap_on_wait_act_init_proc,
        &daObjTnTrap_c::demo_regist_wait_act_init_proc,
        &daObjTnTrap_c::dummy_proc,
        &daObjTnTrap_c::demo_wait2_act_init_proc,
        &daObjTnTrap_c::demo_end_wait_act_init_proc,
        &daObjTnTrap_c::dummy_proc,
    };

    (this->*act_init_proc[param_1])();
    mActionFunc = act_proc[param_1];
    field_0xDC0 = param_1;
}

/* 00001AE4-00001BE8       .text _execute__13daObjTnTrap_cFv */
bool daObjTnTrap_c::_execute() {

    if(field_0xD58 && field_0xD58->ChkUsed()){
        field_0xD58->Move();
    }
    int i;
    for(i = 0; i < 2; i++){
        set_tri(i);
    }
    mStts.Move();
    if((this->*mActionFunc)() == 1){
        for(i = 0; i < 2; i++){
            for(int j = 0; j < 4; j++){
                dComIfG_Ccsp()->Set(&mTri[i][j]);
            }
        }
        set_se();
    }
    return true;
}

/* 00001BE8-00001BF0       .text _draw__13daObjTnTrap_cFv */
bool daObjTnTrap_c::_draw() {
    return true;
}

/* 00001BF0-00001C10       .text daObjTnTrap_Create__FP10fopAc_ac_c */
static cPhs_State daObjTnTrap_Create(fopAc_ac_c* obj) {
    return ((daObjTnTrap_c*)obj)->_create();
}

/* 00001C10-00001C34       .text daObjTnTrap_Delete__FP13daObjTnTrap_c */
static BOOL daObjTnTrap_Delete(daObjTnTrap_c* obj) {
    return ((daObjTnTrap_c*)obj)->_delete();

}

/* 00001C34-00001C58       .text daObjTnTrap_Execute__FP13daObjTnTrap_c */
static BOOL daObjTnTrap_Execute(daObjTnTrap_c* obj) {
    return ((daObjTnTrap_c*)obj)->_execute();
}

/* 00001C58-00001C7C       .text daObjTnTrap_Draw__FP13daObjTnTrap_c */
static BOOL daObjTnTrap_Draw(daObjTnTrap_c* obj) {
    return ((daObjTnTrap_c*)obj)->_draw();
}

/* 00001C7C-00001C84       .text daObjTnTrap_IsDelete__FP13daObjTnTrap_c */
static BOOL daObjTnTrap_IsDelete(daObjTnTrap_c* obj) {
    return TRUE;
}

static actor_method_class l_daObjTnTrap_Method = {
    (process_method_func)daObjTnTrap_Create,
    (process_method_func)daObjTnTrap_Delete,
    (process_method_func)daObjTnTrap_Execute,
    (process_method_func)daObjTnTrap_IsDelete,
    (process_method_func)daObjTnTrap_Draw,
};

actor_process_profile_definition g_profile_Obj_TnTrap = {
    /* LayerID      */ fpcLy_CURRENT_e,
    /* ListID       */ 0x0007,
    /* ListPrio     */ fpcPi_CURRENT_e,
    /* ProcName     */ PROC_Obj_TnTrap,
    /* Proc SubMtd  */ &g_fpcLf_Method.base,
    /* Size         */ sizeof(daObjTnTrap_c),
    /* SizeOther    */ 0,
    /* Parameters   */ 0,
    /* Leaf SubMtd  */ &g_fopAc_Method.base,
    /* Priority     */ PRIO_Obj_TnTrap,
    /* Actor SubMtd */ &l_daObjTnTrap_Method,
    /* Status       */ fopAcStts_CULL_e | fopAcStts_UNK4000_e | fopAcStts_UNK40000_e,
    /* Group        */ fopAc_ACTOR_e,
    /* CullType     */ fopAc_CULLBOX_0_e,
};
